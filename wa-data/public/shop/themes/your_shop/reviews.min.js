$(function(){function e(){var e=$(".review-submit input[type='submit']");e.hasClass("active")||(e.addClass("active"),$(".review-field").each(function(e,t){t=$(t);var r=t.find("input"),a=t.find("textarea");r.length&&r.val()==r.attr("placeholder")&&r.val(""),a.length&&a.val()==a.attr("placeholder")&&a.val("")}),$.post(location.href.replace(/\/#|\/$/g,"")+"/add/",s.serialize(),function(a){if(e.removeClass("active"),"fail"==a.status)return r(s,!1),void t(s,a.errors);if("ok"!=a.status||!a.data.html)return void(console&&console.error("Error occured."));var i=a.data.html,n=parseInt(a.data.parent_id,10)||0,d=n?s.parents("li:first"):o,l=$("ul.reviews-branch:first",d);n?l.show().append(i):l.show().prepend(i),$(".reviews-count-text").text(a.data.review_count_str),$(".reviews-count .count").text(a.data.count),$("#product-tabs .count").text(a.data.count),s.find("input[name=count]").val(a.data.count),r(s,!0),o.find(".write-review").click(),c.hide(),"function"==typeof success&&success(a)},"json").error(function(e){console&&console.error(e.responseText?"Error occured: "+e.responseText:"Error occured.")}))}function t(e,t){for(var r in t)$("[name="+r+"]",e).after($('<em class="errormsg"></em>').text(t[r])).addClass("error")}function r(e,t){t="undefined"==typeof t?!0:t,$(".errormsg",e).remove(),$(".error",e).removeClass("error"),$(".wa-captcha-refresh",e).click(),t&&($("input[name=captcha], textarea",e).val(""),$("input[name=rate]",e).val(0),$("input[name=title]",e).val(""),$(".rate",e).trigger("clear"))}function a(e){var t=this;e?(t.parents(".actions:first").after(c),$(".rate ",s).trigger("clear").parents(".review-field:first").hide()):($("#reviews .reviews").prepend(c),s.find(".rate").parents(".review-field:first").show()),r(s,!1),$("input[name=parent_id]",s).val(e),c.show()}function i(e,t,r){var a=n[t];s.off("keydown",e).on("keydown",e,function(e){return e.keyCode==a.key&&e.altKey==a.alt&&e.ctrlKey==a.ctrl&&e.shiftKey==a.shift?r():void 0})}var n={"alt+enter":{ctrl:!1,alt:!0,shift:!1,key:13},"ctrl+enter":{ctrl:!0,alt:!1,shift:!1,key:13},"ctrl+s":{ctrl:!0,alt:!1,shift:!1,key:17}},c=$(document).find("#product-review-form"),s=c.find("form"),o=$(document);defaultInputValue($("#review-name"),"empty"),defaultInputValue($("#review-email"),"empty"),defaultInputValue($("#review-site"),"empty"),defaultInputValue($("#review-title"),"empty"),defaultInputValue($("#review-text"),"empty");var d=s.find("input[name=rate]");d.length||(d=$('<input name="rate" type="hidden" value=0>').appendTo(s)),$("#review-rate").rateWidget({onUpdate:function(e){d.val(e)}}),o.off("click",".review-reply, .write-review").on("click",".review-reply, .write-review",function(){var e=$(this),t=e.parents("li:first"),r=parseInt(t.attr("data-id"),10)||0;return a.call(e,r),!1});var l=$(".wa-captcha"),u=$("#user-auth-provider li"),p=u.filter(".selected").attr("data-provider");"guest"!=p&&p?l.hide():l.show(),u.find("a").click(function(){var e=$(this),t=e.parents("li:first");if(t.hasClass("selected"))return!1;t.siblings(".selected").removeClass("selected"),t.addClass("selected");var r=t.attr("data-provider");if(s.find("input[name=auth_provider]").val(r),"guest"==r)return $("div.provider-fields").hide(),$("div.provider-fields[data-provider=guest]").show(),l.show(),!1;if(r==p)return $("div.provider-fields").hide(),$("div.provider-fields[data-provider="+r+"]").show(),l.hide(),!1;var a=(screen.width-600)/2,i=(screen.height-400)/2;return window.open($(this).attr("href"),"oauth","width=600,height=400,left="+a+",top="+i+",status=no,toolbar=no,menubar=no"),!1}),i("textarea","ctrl+enter",e),s.submit(function(){return e(),!1}),$("div.wa-captcha .wa-captcha-refresh, div.wa-captcha .wa-captcha-img").click(function(){var e=$(this).parents("div.wa-captcha"),t=e.find(".wa-captcha-img");return t.length&&($("div.wa-captcha .wa-captcha-refresh").after("<i class='icon16 loading'></i>"),t.attr("src",t.attr("src").replace(/\?.*$/,"?rid="+Math.random())),t.one("load",function(){$("div.wa-captcha .wa-captcha-refresh").next("i").remove(),e.find(".wa-captcha-input").focus()})),e.find("input").val(""),!1})});